name: Odoo Addons Deployment

on:
  push:
    branches:
      - dev
      - prod

jobs:
  deploy:
    runs-on: ubuntu-latest
    
    env:
      TARGET_BRANCH: ${{ github.ref_name }}
      
    steps:
      - name: Checkout Code
        uses: actions/checkout@v4

      - name: Configure Environment Variables
        run: |
          if [ "${{ env.TARGET_BRANCH }}" == "dev" ]; then
            echo "HOST=${{ secrets.TEST_HOST }}" >> $GITHUB_ENV
            echo "SSH_USER=${{ secrets.TEST_USER }}" >> $GITHUB_ENV
            echo "REMOTE_BASE_PATH=/home/odoo/develop" >> $GITHUB_ENV
            echo "REMOTE_ADDONS_PATH=/home/odoo/develop/addons" >> $GITHUB_ENV
          elif [ "${{ env.TARGET_BRANCH }}" == "prod" ]; then
            echo "HOST=${{ secrets.PROD_HOST }}" >> $GITHUB_ENV
            echo "SSH_USER=${{ secrets.PROD_USER }}" >> $GITHUB_ENV
            echo "REMOTE_BASE_PATH=/home/nabel/odoo-16-docker" >> $GITHUB_ENV
            echo "REMOTE_ADDONS_PATH=/home/nabel/odoo-16-docker/addons" >> $GITHUB_ENV
          else
            echo "Unknown branch. Exiting."
            exit 1
          fi

      # NOUVEAU : 1. Démarrer l'agent SSH et ajouter la clé privée
      - name: Start SSH Agent and Load Key
        uses: webfactory/ssh-agent@v0.9.0
        with:
          ssh-private-key: ${{ secrets.SSH_PRIVATE_KEY }}

      - name: Deploy Addons and Restart Odoo Container
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ env.HOST }}
          username: ${{ env.SSH_USER }}
          # REMARQUE : L'agent SSH de l'action n'est plus utilisé pour l'authentification de la connexion principale, 
          # mais il est souvent nécessaire de le laisser pour l'action `appleboy` elle-même.
          key: ${{ secrets.SSH_PRIVATE_KEY }} 
          
          # La clé est maintenant chargée dans l'environnement du Runner (grâce à webfactory/ssh-agent)
          script: |
            echo "Starting deployment for ${{ env.TARGET_BRANCH }}..."
            
            # 1. Transfer files
            echo "Transferring new addons to ${{ env.REMOTE_ADDONS_PATH }}..."
            
            # AJOUT : L'option -A (Agent Forwarding) pour rsync, lui permettant 
            # d'utiliser la clé chargée par webfactory/ssh-agent.
            rsync -avz --delete -e "ssh -A -o StrictHostKeyChecking=no" ./ ${{ env.SSH_USER }}@${{ env.HOST }}:${{ env.REMOTE_ADDONS_PATH }}/

            # 2. Restart Odoo container
            echo "Restarting Odoo service 'odoo16'..."
            cd ${{ env.REMOTE_BASE_PATH }}
            docker compose restart odoo16
            
            echo "Deployment complete."